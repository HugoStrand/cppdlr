\hypertarget{dlr__imtime_8hpp_source}{}\doxysection{dlr\+\_\+imtime.\+hpp}
\label{dlr__imtime_8hpp_source}\index{/mnt/home/jkaye/Documents/projects/cppdlr/c++/cppdlr/dlr\_imtime.hpp@{/mnt/home/jkaye/Documents/projects/cppdlr/c++/cppdlr/dlr\_imtime.hpp}}
\mbox{\hyperlink{dlr__imtime_8hpp}{Go to the documentation of this file.}}
\begin{DoxyCode}{0}
\DoxyCodeLine{00001\ \textcolor{comment}{//\ Copyright\ (c)\ 2022-\/2023\ Simons\ Foundation}}
\DoxyCodeLine{00002\ \textcolor{comment}{//\ Copyright\ (c)\ 2023\ Hugo\ Strand}}
\DoxyCodeLine{00003\ \textcolor{comment}{//}}
\DoxyCodeLine{00004\ \textcolor{comment}{//\ Licensed\ under\ the\ Apache\ License,\ Version\ 2.0\ (the\ "{}License"{});}}
\DoxyCodeLine{00005\ \textcolor{comment}{//\ you\ may\ not\ use\ this\ file\ except\ in\ compliance\ with\ the\ License.}}
\DoxyCodeLine{00006\ \textcolor{comment}{//\ You\ may\ obtain\ a\ copy\ of\ the\ License\ at}}
\DoxyCodeLine{00007\ \textcolor{comment}{//}}
\DoxyCodeLine{00008\ \textcolor{comment}{//\ \ \ \ \ http://www.apache.org/licenses/LICENSE-\/2.0.txt}}
\DoxyCodeLine{00009\ \textcolor{comment}{//}}
\DoxyCodeLine{00010\ \textcolor{comment}{//\ Unless\ required\ by\ applicable\ law\ or\ agreed\ to\ in\ writing,\ software}}
\DoxyCodeLine{00011\ \textcolor{comment}{//\ distributed\ under\ the\ License\ is\ distributed\ on\ an\ "{}AS\ IS"{}\ BASIS,}}
\DoxyCodeLine{00012\ \textcolor{comment}{//\ WITHOUT\ WARRANTIES\ OR\ CONDITIONS\ OF\ ANY\ KIND,\ either\ express\ or\ implied.}}
\DoxyCodeLine{00013\ \textcolor{comment}{//\ See\ the\ License\ for\ the\ specific\ language\ governing\ permissions\ and}}
\DoxyCodeLine{00014\ \textcolor{comment}{//\ limitations\ under\ the\ License.}}
\DoxyCodeLine{00015\ \textcolor{comment}{//}}
\DoxyCodeLine{00016\ \textcolor{comment}{//\ Authors:\ Hugo\ U.\ R.\ Strand,\ Nils\ Wentzell,\ Jason\ Kaye}}
\DoxyCodeLine{00017\ }
\DoxyCodeLine{00018\ \textcolor{preprocessor}{\#pragma\ once}}
\DoxyCodeLine{00019\ \textcolor{preprocessor}{\#include\ <nda/nda.hpp>}}
\DoxyCodeLine{00020\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{dlr__kernels_8hpp}{cppdlr/dlr\_kernels.hpp}}"{}}}
\DoxyCodeLine{00021\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{dlr__build_8hpp}{cppdlr/dlr\_build.hpp}}"{}}}
\DoxyCodeLine{00022\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{utils_8hpp}{cppdlr/utils.hpp}}"{}}}
\DoxyCodeLine{00023\ \textcolor{preprocessor}{\#include\ "{}nda/clef/clef.hpp"{}}}
\DoxyCodeLine{00024\ }
\DoxyCodeLine{00025\ \textcolor{preprocessor}{\#include\ <h5/h5.hpp>}}
\DoxyCodeLine{00026\ \textcolor{preprocessor}{\#include\ <nda/h5.hpp>}}
\DoxyCodeLine{00027\ }
\DoxyCodeLine{00028\ \textcolor{keyword}{namespace\ }\mbox{\hyperlink{namespacecppdlr}{cppdlr}}\ \{}
\DoxyCodeLine{00029\ }
\DoxyCodeLine{00030\ \ \ \textcolor{keyword}{static}\ \textcolor{keyword}{constexpr}\ \textcolor{keyword}{auto}\ \_\ =\ nda::range::all;}
\DoxyCodeLine{00031\ }
\DoxyCodeLine{00035\ \ \ \textcolor{keyword}{enum}\ \{\ \mbox{\hyperlink{namespacecppdlr_a129c05d03fc8311641a3187782ee074da196a077d1e896d9af1eaa919f5d55dcb}{ORDINARY}}\ =\ \textcolor{keyword}{false},\ \mbox{\hyperlink{namespacecppdlr_a129c05d03fc8311641a3187782ee074da25ad4cbf4bfe01f97a6f2e2e1b9781e6}{TIME\_ORDERED}}\ =\ \textcolor{keyword}{true}\ \};}
\DoxyCodeLine{00036\ }
\DoxyCodeLine{00046\ \ \ \textcolor{keyword}{class\ }\mbox{\hyperlink{classcppdlr_1_1imtime__ops}{imtime\_ops}}\ \{}
\DoxyCodeLine{00047\ }
\DoxyCodeLine{00048\ \ \ \ \ \textcolor{keyword}{public}:}
\DoxyCodeLine{00055\ \ \ \ \ \mbox{\hyperlink{classcppdlr_1_1imtime__ops_a8da78cf54d39d48d2be19ad1f146b03c}{imtime\_ops}}(\textcolor{keywordtype}{double}\ \mbox{\hyperlink{classcppdlr_1_1imtime__ops_a401521dedc309ca12c1ec345da983c80}{lambda}},\ nda::vector\_const\_view<double>\ dlr\_rf);}
\DoxyCodeLine{00056\ }
\DoxyCodeLine{00057\ \ \ \ \ \mbox{\hyperlink{classcppdlr_1_1imtime__ops_a43a9b5fb6aeefad7d8ae6865329e69de}{imtime\_ops}}(\textcolor{keywordtype}{double}\ \mbox{\hyperlink{classcppdlr_1_1imtime__ops_a401521dedc309ca12c1ec345da983c80}{lambda}},\ nda::vector\_const\_view<double>\ dlr\_rf,\ nda::vector\_const\_view<double>\ dlr\_it,\ nda::matrix\_const\_view<double>\ cf2it,}
\DoxyCodeLine{00058\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ nda::matrix\_const\_view<double>\ it2cf\_lu,\ nda::vector\_const\_view<int>\ it2cf\_piv)}
\DoxyCodeLine{00059\ \ \ \ \ \ \ \ :\ lambda\_(\mbox{\hyperlink{classcppdlr_1_1imtime__ops_a401521dedc309ca12c1ec345da983c80}{lambda}}),\ r(dlr\_rf.size()),\ dlr\_rf(dlr\_rf),\ dlr\_it(dlr\_it),\ cf2it(cf2it),\ it2cf\{it2cf\_lu,\ it2cf\_piv\}\ \{\};}
\DoxyCodeLine{00060\ }
\DoxyCodeLine{00061\ \ \ \ \ \mbox{\hyperlink{classcppdlr_1_1imtime__ops_a8da78cf54d39d48d2be19ad1f146b03c}{imtime\_ops}}()\ =\ \textcolor{keywordflow}{default};}
\DoxyCodeLine{00062\ }
\DoxyCodeLine{00071\ \ \ \ \ \textcolor{keyword}{template}\ <nda::MemoryArray\ T,\ nda::Scalar\ S\ =\ nda::get\_value\_t<T>>\ \textcolor{keyword}{typename}\ T::regular\_type\ \mbox{\hyperlink{classcppdlr_1_1imtime__ops_a8b83b15a4fa3eefe8f10d65a53b5885d}{vals2coefs}}(T\ \textcolor{keyword}{const}\ \&g)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00072\ }
\DoxyCodeLine{00073\ \ \ \ \ \ \ \textcolor{comment}{//\ MemoryArray\ type\ can\ be\ nda\ vector,\ matrix,\ array,\ or\ view\ of\ any\ of}}
\DoxyCodeLine{00074\ \ \ \ \ \ \ \textcolor{comment}{//\ these;\ taking\ a\ regular\_type\ converts,\ for\ example,\ a\ matrix\ view\ to\ a}}
\DoxyCodeLine{00075\ \ \ \ \ \ \ \textcolor{comment}{//\ matrix.}}
\DoxyCodeLine{00076\ }
\DoxyCodeLine{00077\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (r\ !=\ g.shape(0))\ \textcolor{keywordflow}{throw}\ std::runtime\_error(\textcolor{stringliteral}{"{}First\ dim\ of\ g\ !=\ DLR\ rank\ r."{}});}
\DoxyCodeLine{00078\ }
\DoxyCodeLine{00079\ \ \ \ \ \ \ \textcolor{comment}{//\ Reshape\ g\ to\ matrix\ w/\ first\ dimension\ r}}
\DoxyCodeLine{00080\ \ \ \ \ \ \ \textcolor{keyword}{auto}\ g\_rs\ =\ nda::reshape(g,\ r,\ g.size()\ /\ r);}
\DoxyCodeLine{00081\ \ \ \ \ \ \ \textcolor{keyword}{auto}\ gct\ \ =\ nda::matrix<S>(transpose(g\_rs));}
\DoxyCodeLine{00082\ }
\DoxyCodeLine{00083\ \ \ \ \ \ \ \textcolor{comment}{//\ Solve\ linear\ system\ (multiple\ right\ hand\ sides)\ to\ convert\ vals\ -\/>}}
\DoxyCodeLine{00084\ \ \ \ \ \ \ \textcolor{comment}{//\ coeffs\ (we\ transpose\ because\ LAPACK\ requires\ index\ into\ RHS\ \#\ to\ be}}
\DoxyCodeLine{00085\ \ \ \ \ \ \ \textcolor{comment}{//\ slowest)}}
\DoxyCodeLine{00086\ }
\DoxyCodeLine{00087\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ \textcolor{keyword}{constexpr}\ (nda::have\_same\_value\_type\_v<T,\ \textcolor{keyword}{decltype}(it2cf.lu)>)\ \{}
\DoxyCodeLine{00088\ \ \ \ \ \ \ \ \ nda::lapack::getrs(it2cf.lu,\ gct,\ it2cf.piv);}
\DoxyCodeLine{00089\ \ \ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00090\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ getrs\ requires\ matrix\ and\ rhs\ to\ have\ same\ value\ type}}
\DoxyCodeLine{00091\ \ \ \ \ \ \ \ \ nda::lapack::getrs(nda::matrix<S>(it2cf.lu),\ gct,\ it2cf.piv);}
\DoxyCodeLine{00092\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00093\ }
\DoxyCodeLine{00094\ \ \ \ \ \ \ \textcolor{comment}{//\ Reshape\ to\ original\ dimensions\ and\ return}}
\DoxyCodeLine{00095\ \ \ \ \ \ \ \textcolor{keyword}{auto}\ gc\ =\ nda::matrix<S>(transpose(gct));}
\DoxyCodeLine{00096\ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ nda::reshape(gc,\ g.shape());}
\DoxyCodeLine{00097\ \ \ \ \ \}}
\DoxyCodeLine{00098\ }
\DoxyCodeLine{00107\ \ \ \ \ \textcolor{keyword}{template}\ <nda::MemoryArray\ T,\ nda::Scalar\ S\ =\ nda::get\_value\_t<T>>\ \textcolor{keyword}{typename}\ T::regular\_type\ \mbox{\hyperlink{classcppdlr_1_1imtime__ops_a6f6d71c061aec134df9edf1255e19dfb}{coefs2vals}}(T\ \textcolor{keyword}{const}\ \&gc)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00108\ }
\DoxyCodeLine{00109\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (r\ !=\ gc.shape(0))\ \textcolor{keywordflow}{throw}\ std::runtime\_error(\textcolor{stringliteral}{"{}First\ dim\ of\ g\ !=\ DLR\ rank\ r."{}});}
\DoxyCodeLine{00110\ }
\DoxyCodeLine{00111\ \ \ \ \ \ \ \textcolor{comment}{//\ Reshape\ gc\ to\ a\ matrix\ w/\ first\ dimension\ r}}
\DoxyCodeLine{00112\ \ \ \ \ \ \ \textcolor{keyword}{auto}\ gc\_rs\ =\ nda::reshape(gc,\ r,\ gc.size()\ /\ r);}
\DoxyCodeLine{00113\ }
\DoxyCodeLine{00114\ \ \ \ \ \ \ \textcolor{comment}{//\ Apply\ coeffs\ -\/>\ vals\ matrix}}
\DoxyCodeLine{00115\ \ \ \ \ \ \ \textcolor{keyword}{auto}\ g\ =\ cf2it\ *\ nda::matrix\_const\_view<S>(gc\_rs);}
\DoxyCodeLine{00116\ }
\DoxyCodeLine{00117\ \ \ \ \ \ \ \textcolor{comment}{//\ Reshape\ to\ original\ dimensions\ and\ return}}
\DoxyCodeLine{00118\ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ nda::reshape(g,\ gc.shape());}
\DoxyCodeLine{00119\ \ \ \ \ \}}
\DoxyCodeLine{00120\ }
\DoxyCodeLine{00135\ \ \ \ \ \textcolor{keyword}{template}\ <nda::MemoryArray\ T,\ nda::Scalar\ S\ =\ nda::get\_value\_t<T>>\ \textcolor{keyword}{auto}\ \mbox{\hyperlink{classcppdlr_1_1imtime__ops_a12761a877407fc347dc695da4b2d7f3d}{coefs2eval}}(T\ \textcolor{keyword}{const}\ \&gc,\ \textcolor{keywordtype}{double}\ t)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00136\ }
\DoxyCodeLine{00137\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (r\ !=\ gc.shape(0))\ \textcolor{keywordflow}{throw}\ std::runtime\_error(\textcolor{stringliteral}{"{}First\ dim\ of\ g\ !=\ DLR\ rank\ r."{}});}
\DoxyCodeLine{00138\ }
\DoxyCodeLine{00139\ \ \ \ \ \ \ \textcolor{comment}{//\ Scalar-\/valued\ Green's\ functions\ are\ handled\ differently\ than\ matrix-\/valued\ Green's\ functions}}
\DoxyCodeLine{00140\ }
\DoxyCodeLine{00141\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ \textcolor{keyword}{constexpr}\ (T::rank\ ==\ 1)\ \{}
\DoxyCodeLine{00142\ }
\DoxyCodeLine{00143\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ TODO:\ can\ be\ further\ optimized\ to\ reduce\ \#\ exponential\ evals.}}
\DoxyCodeLine{00144\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Evaluate\ DLR\ expansion}}
\DoxyCodeLine{00145\ \ \ \ \ \ \ \ \ S\ g\ =\ 0;}
\DoxyCodeLine{00146\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (t\ >=\ 0)\ \{}
\DoxyCodeLine{00147\ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ l\ =\ 0;\ l\ <\ r;\ ++l)\ \{\ g\ +=\ \mbox{\hyperlink{namespacecppdlr_a7dfaf907221eb1768418258421af703f}{k\_it\_abs}}(t,\ dlr\_rf(l))\ *\ gc(l);\ \}}
\DoxyCodeLine{00148\ \ \ \ \ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00149\ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ l\ =\ 0;\ l\ <\ r;\ ++l)\ \{\ g\ +=\ \mbox{\hyperlink{namespacecppdlr_a7dfaf907221eb1768418258421af703f}{k\_it\_abs}}(-\/t,\ -\/dlr\_rf(l))\ *\ gc(l);\ \}}
\DoxyCodeLine{00150\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00151\ }
\DoxyCodeLine{00152\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ g;}
\DoxyCodeLine{00153\ \ \ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00154\ }
\DoxyCodeLine{00155\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Reshape\ gc\ to\ matrix\ w/\ first\ dimension\ r}}
\DoxyCodeLine{00156\ \ \ \ \ \ \ \ \ \textcolor{keyword}{auto}\ gc\_rs\ =\ nda::reshape(gc,\ r,\ gc.size()\ /\ r);}
\DoxyCodeLine{00157\ }
\DoxyCodeLine{00158\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Get\ output\ shape}}
\DoxyCodeLine{00159\ \ \ \ \ \ \ \ \ std::array<long,\ T::rank\ -\/\ 1>\ shape\_out;}
\DoxyCodeLine{00160\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ i\ =\ 0;\ i\ <\ T::rank\ -\/\ 1;\ ++i)\ \{\ shape\_out[i]\ =\ gc.shape(i\ +\ 1);\ \}}
\DoxyCodeLine{00161\ }
\DoxyCodeLine{00162\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Get\ vector\ of\ evaluation\ of\ DLR\ expansion\ at\ a\ point}}
\DoxyCodeLine{00163\ \ \ \ \ \ \ \ \ \textcolor{keyword}{auto}\ kvec\ =\ \mbox{\hyperlink{classcppdlr_1_1imtime__ops_a318b0b4409d0488814bb8db12c8b0611}{build\_evalvec}}(t);}
\DoxyCodeLine{00164\ }
\DoxyCodeLine{00165\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Evaluate\ DLR\ expansion,\ reshape\ to\ original\ dimensions\ (with\ first}}
\DoxyCodeLine{00166\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ dimension\ summed\ out),\ and\ return}}
\DoxyCodeLine{00167\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ nda::reshape(transpose(nda::matrix\_const\_view<S>(gc\_rs))\ *\ kvec,\ shape\_out);}
\DoxyCodeLine{00168\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00169\ \ \ \ \ \}}
\DoxyCodeLine{00170\ }
\DoxyCodeLine{00183\ \ \ \ \ nda::vector<double>\ \mbox{\hyperlink{classcppdlr_1_1imtime__ops_a318b0b4409d0488814bb8db12c8b0611}{build\_evalvec}}(\textcolor{keywordtype}{double}\ t)\ \textcolor{keyword}{const};}
\DoxyCodeLine{00184\ }
\DoxyCodeLine{00194\ \ \ \ \ \textcolor{keyword}{template}\ <nda::MemoryArray\ T,\ nda::Scalar\ S\ =\ nda::get\_value\_t<T>>}
\DoxyCodeLine{00195\ \ \ \ \ \textcolor{keyword}{typename}\ T::regular\_type\ \mbox{\hyperlink{classcppdlr_1_1imtime__ops_a6a81a99b2858defa9513a395bd35e2bf}{fitvals2coefs}}(nda::vector\_const\_view<double>\ t,\ T\ \textcolor{keyword}{const}\ \&g)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00196\ }
\DoxyCodeLine{00197\ \ \ \ \ \ \ \textcolor{comment}{//\ Check\ first\ dimension\ of\ g\ equal\ to\ length\ of\ t}}
\DoxyCodeLine{00198\ \ \ \ \ \ \ \textcolor{keywordtype}{int}\ n\ =\ t.size();}
\DoxyCodeLine{00199\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (n\ !=\ g.shape(0))\ \textcolor{keywordflow}{throw}\ std::runtime\_error(\textcolor{stringliteral}{"{}First\ dim\ of\ g\ must\ be\ equal\ to\ length\ of\ t."{}});}
\DoxyCodeLine{00200\ }
\DoxyCodeLine{00201\ \ \ \ \ \ \ \textcolor{comment}{//\ Get\ matrix\ for\ least\ squares\ fitting:\ columns\ are\ DLR\ basis\ functions}}
\DoxyCodeLine{00202\ \ \ \ \ \ \ \textcolor{comment}{//\ evaluating\ at\ data\ points\ t.\ Must\ built\ in\ Fortran\ layout\ for}}
\DoxyCodeLine{00203\ \ \ \ \ \ \ \textcolor{comment}{//\ compatibility\ with\ LAPACK.}}
\DoxyCodeLine{00204\ \ \ \ \ \ \ \textcolor{keyword}{auto}\ kmat\ =\ nda::matrix<S,\ F\_layout>(n,\ r);\ \textcolor{comment}{//\ Make\ sure\ matrix\ has\ same\ scalar\ type\ as\ g}}
\DoxyCodeLine{00205\ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ j\ =\ 0;\ j\ <\ r;\ ++j)\ \{}
\DoxyCodeLine{00206\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ i\ =\ 0;\ i\ <\ n;\ ++i)\ \{\ kmat(i,\ j)\ =\ \mbox{\hyperlink{namespacecppdlr_afc9726e02898098dfff8448f02f5b3c6}{k\_it}}(t(i),\ dlr\_rf(j));\ \}}
\DoxyCodeLine{00207\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00208\ }
\DoxyCodeLine{00209\ \ \ \ \ \ \ \textcolor{comment}{//\ Reshape\ g\ to\ matrix\ w/\ first\ dimension\ n,\ and\ put\ in\ Fortran\ layout\ for}}
\DoxyCodeLine{00210\ \ \ \ \ \ \ \textcolor{comment}{//\ compatibility\ w/\ LAPACK}}
\DoxyCodeLine{00211\ \ \ \ \ \ \ \textcolor{keyword}{auto}\ g\_rs\ =\ nda::matrix<S,\ F\_layout>(nda::reshape(g,\ n,\ g.size()\ /\ n));}
\DoxyCodeLine{00212\ }
\DoxyCodeLine{00213\ \ \ \ \ \ \ \textcolor{comment}{//\ Solve\ least\ squares\ problem\ to\ obtain\ DLR\ coefficients}}
\DoxyCodeLine{00214\ \ \ \ \ \ \ \textcolor{keyword}{auto}\ s\ \ \ =\ nda::vector<double>(r);\ \textcolor{comment}{//\ Singular\ values\ (not\ needed)}}
\DoxyCodeLine{00215\ \ \ \ \ \ \ \textcolor{keywordtype}{int}\ \mbox{\hyperlink{classcppdlr_1_1imtime__ops_a88f437cb31c98929ab8a1e6dadb174aa}{rank}}\ =\ 0;\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Rank\ of\ system\ matrix\ (not\ needed)}}
\DoxyCodeLine{00216\ \ \ \ \ \ \ nda::lapack::gelss(kmat,\ g\_rs,\ s,\ 0.0,\ \mbox{\hyperlink{classcppdlr_1_1imtime__ops_a88f437cb31c98929ab8a1e6dadb174aa}{rank}});}
\DoxyCodeLine{00217\ }
\DoxyCodeLine{00218\ \ \ \ \ \ \ \textcolor{keyword}{auto}\ gc\_shape\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ =\ g.shape();\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Output\ shape\ is\ same\ as\ g...}}
\DoxyCodeLine{00219\ \ \ \ \ \ \ gc\_shape[0]\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ =\ r;\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ ...with\ first\ dimension\ n\ replaced\ by\ r}}
\DoxyCodeLine{00220\ \ \ \ \ \ \ \textcolor{keyword}{auto}\ gc\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ =\ \textcolor{keyword}{typename}\ T::regular\_type(gc\_shape);\ \textcolor{comment}{//\ Output\ array:\ output\ type\ is\ same\ as\ g}}
\DoxyCodeLine{00221\ \ \ \ \ \ \ reshape(gc,\ r,\ g.size()\ /\ n)\ =\ g\_rs(nda::range(r),\ \_);\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Place\ result\ in\ output\ array}}
\DoxyCodeLine{00222\ }
\DoxyCodeLine{00223\ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ gc;}
\DoxyCodeLine{00224\ \ \ \ \ \}}
\DoxyCodeLine{00225\ }
\DoxyCodeLine{00237\ \ \ \ \ \textcolor{keyword}{template}\ <nda::MemoryArray\ T>\ \textcolor{keyword}{typename}\ T::regular\_type\ \mbox{\hyperlink{classcppdlr_1_1imtime__ops_a0ee9bfed6fc9facf2d25cea9868a3af6}{reflect}}(T\ \textcolor{keyword}{const}\ \&g)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00238\ }
\DoxyCodeLine{00239\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (r\ !=\ g.shape(0))\ \textcolor{keywordflow}{throw}\ std::runtime\_error(\textcolor{stringliteral}{"{}First\ dim\ of\ g\ !=\ DLR\ rank\ r."{}});}
\DoxyCodeLine{00240\ }
\DoxyCodeLine{00241\ \ \ \ \ \ \ \textcolor{comment}{//\ Initialize\ reflection\ matrix,\ if\ it\ hasn't\ been\ done\ already}}
\DoxyCodeLine{00242\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (refl.empty())\ \{\ \mbox{\hyperlink{classcppdlr_1_1imtime__ops_a3a47942235e7330cc6d392dc881d256f}{reflect\_init}}();\ \}}
\DoxyCodeLine{00243\ }
\DoxyCodeLine{00244\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ \textcolor{keyword}{constexpr}\ (T::rank\ ==\ 1)\ \{\ \textcolor{comment}{//\ Scalar-\/valued\ Green's\ function}}
\DoxyCodeLine{00245\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ matmul(refl,\ g);}
\DoxyCodeLine{00246\ \ \ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00247\ \ \ \ \ \ \ \ \ \textcolor{keyword}{auto}\ gr\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ =\ \textcolor{keyword}{typename}\ T::regular\_type(g.shape());\ \ \ \ \ \ \ \textcolor{comment}{//\ Output\ has\ same\ type/shape\ as\ g}}
\DoxyCodeLine{00248\ \ \ \ \ \ \ \ \ reshape(gr,\ r,\ g.size()\ /\ r)\ =\ matmul(refl,\ reshape(g,\ r,\ g.size()\ /\ r));\ \textcolor{comment}{//\ Reshape,\ matrix\ multiply,\ reshape\ back}}
\DoxyCodeLine{00249\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ gr;}
\DoxyCodeLine{00250\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00251\ \ \ \ \ \}}
\DoxyCodeLine{00252\ }
\DoxyCodeLine{00253\ }
\DoxyCodeLine{00283\ \ \ \ \ \textcolor{keyword}{template}\ <nda::MemoryArray\ T,\ nda::Scalar\ S\ =\ nda::get\_value\_t<T>>}
\DoxyCodeLine{00284\ \ \ \ \ \textcolor{keyword}{typename}\ T::regular\_type\ \mbox{\hyperlink{classcppdlr_1_1imtime__ops_a4f018cf316547b2879d9a2dd76a4b80c}{convolve}}(\textcolor{keywordtype}{double}\ beta,\ \mbox{\hyperlink{namespacecppdlr_ad0a7e33d9a03f4986937032c25ee7435}{statistic\_t}}\ statistic,\ T\ \textcolor{keyword}{const}\ \&fc,\ T\ \textcolor{keyword}{const}\ \&gc,\ \textcolor{keywordtype}{bool}\ time\_order\ =\ \textcolor{keyword}{false})\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00285\ }
\DoxyCodeLine{00286\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (r\ !=\ fc.shape(0)\ ||\ r\ !=\ gc.shape(0))\ \textcolor{keywordflow}{throw}\ std::runtime\_error(\textcolor{stringliteral}{"{}First\ dim\ of\ input\ arrays\ must\ be\ equal\ to\ DLR\ rank\ r."{}});}
\DoxyCodeLine{00287\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (fc.shape()\ !=\ gc.shape())\ \textcolor{keywordflow}{throw}\ std::runtime\_error(\textcolor{stringliteral}{"{}Input\ arrays\ must\ have\ the\ same\ shape."{}});}
\DoxyCodeLine{00288\ }
\DoxyCodeLine{00289\ \ \ \ \ \ \ \textcolor{comment}{//\ TODO:\ implement\ bosonic\ case\ and\ remove}}
\DoxyCodeLine{00290\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (statistic\ ==\ 0)\ \textcolor{keywordflow}{throw}\ std::runtime\_error(\textcolor{stringliteral}{"{}imtime\_ops::convolve\ not\ yet\ implemented\ for\ bosonic\ Green's\ functions."{}});}
\DoxyCodeLine{00291\ }
\DoxyCodeLine{00292\ \ \ \ \ \ \ \textcolor{comment}{//\ Initialize\ convolution,\ if\ it\ hasn't\ been\ done\ already}}
\DoxyCodeLine{00293\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (!time\_order\ \&\ hilb.empty())\ \{\ \mbox{\hyperlink{classcppdlr_1_1imtime__ops_a6257e0b3f43733c5ac06c8af11a47bb3}{convolve\_init}}();\ \}}
\DoxyCodeLine{00294\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (time\_order\ \&\ thilb.empty())\ \{\ \mbox{\hyperlink{classcppdlr_1_1imtime__ops_ae6116f42e1f17050404974d0d6d3d226}{tconvolve\_init}}();\ \}}
\DoxyCodeLine{00295\ }
\DoxyCodeLine{00296\ \ \ \ \ \ \ \textcolor{comment}{//\ Get\ view\ of\ helper\ matrices\ based\ on\ time\_order\ flag}}
\DoxyCodeLine{00297\ \ \ \ \ \ \ \textcolor{keyword}{auto}\ hilb\_v\ \ \ =\ (time\_order\ ?\ nda::matrix\_const\_view<double>(thilb)\ :\ nda::matrix\_const\_view<double>(hilb));}
\DoxyCodeLine{00298\ \ \ \ \ \ \ \textcolor{keyword}{auto}\ tcf2it\_v\ =\ (time\_order\ ?\ nda::matrix\_const\_view<double>(ttcf2it)\ :\ nda::matrix\_const\_view<double>(tcf2it));}
\DoxyCodeLine{00299\ }
\DoxyCodeLine{00300\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ \textcolor{keyword}{constexpr}\ (T::rank\ ==\ 1)\ \{\ \textcolor{comment}{//\ Scalar-\/valued\ Green's\ function}}
\DoxyCodeLine{00301\ }
\DoxyCodeLine{00302\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Take\ array\ view\ of\ fc\ and\ gc}}
\DoxyCodeLine{00303\ \ \ \ \ \ \ \ \ \textcolor{keyword}{auto}\ fca\ =\ nda::array\_const\_view<S,\ 1>(fc);}
\DoxyCodeLine{00304\ \ \ \ \ \ \ \ \ \textcolor{keyword}{auto}\ gca\ =\ nda::array\_const\_view<S,\ 1>(gc);}
\DoxyCodeLine{00305\ }
\DoxyCodeLine{00306\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Diagonal\ contribution}}
\DoxyCodeLine{00307\ \ \ \ \ \ \ \ \ \textcolor{keyword}{auto}\ h\ =\ \mbox{\hyperlink{namespacecppdlr_a623b3f78817239e2d1653be8972cc5f1}{arraymult}}(tcf2it\_v,\ make\_regular(fca\ *\ gca));}
\DoxyCodeLine{00308\ }
\DoxyCodeLine{00309\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Off-\/diagonal\ contribution}}
\DoxyCodeLine{00310\ \ \ \ \ \ \ \ \ \textcolor{keyword}{auto}\ tmp\ =\ fca\ *\ \mbox{\hyperlink{namespacecppdlr_a623b3f78817239e2d1653be8972cc5f1}{arraymult}}(hilb\_v,\ gca)\ +\ gca\ *\ \mbox{\hyperlink{namespacecppdlr_a623b3f78817239e2d1653be8972cc5f1}{arraymult}}(hilb\_v,\ fca);}
\DoxyCodeLine{00311\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ beta\ *\ (h\ +\ \mbox{\hyperlink{namespacecppdlr_a623b3f78817239e2d1653be8972cc5f1}{arraymult}}(cf2it,\ make\_regular(tmp)));}
\DoxyCodeLine{00312\ }
\DoxyCodeLine{00313\ \ \ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \textcolor{keywordflow}{if}\ (T::rank\ ==\ 3)\ \{\ \textcolor{comment}{//\ Matrix-\/valued\ Green's\ function}}
\DoxyCodeLine{00314\ }
\DoxyCodeLine{00315\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Diagonal\ contribution}}
\DoxyCodeLine{00316\ \ \ \ \ \ \ \ \ \textcolor{keyword}{auto}\ fcgc\ =\ nda::array<S,\ 3>(fc.shape());\ \textcolor{comment}{//\ Product\ of\ coefficients\ of\ f\ and\ g}}
\DoxyCodeLine{00317\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ i\ =\ 0;\ i\ <\ r;\ ++i)\ \{\ fcgc(i,\ \_,\ \_)\ =\ \mbox{\hyperlink{namespacecppdlr_a623b3f78817239e2d1653be8972cc5f1}{arraymult}}(fc(i,\ \_,\ \_),\ gc(i,\ \_,\ \_));\ \}}
\DoxyCodeLine{00318\ \ \ \ \ \ \ \ \ \textcolor{keyword}{auto}\ h\ =\ \mbox{\hyperlink{namespacecppdlr_a623b3f78817239e2d1653be8972cc5f1}{arraymult}}(tcf2it\_v,\ fcgc);}
\DoxyCodeLine{00319\ }
\DoxyCodeLine{00320\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Off-\/diagonal\ contribution}}
\DoxyCodeLine{00321\ \ \ \ \ \ \ \ \ \textcolor{keyword}{auto}\ tmp1\ =\ \mbox{\hyperlink{namespacecppdlr_a623b3f78817239e2d1653be8972cc5f1}{arraymult}}(hilb\_v,\ fc);}
\DoxyCodeLine{00322\ \ \ \ \ \ \ \ \ \textcolor{keyword}{auto}\ tmp2\ =\ \mbox{\hyperlink{namespacecppdlr_a623b3f78817239e2d1653be8972cc5f1}{arraymult}}(hilb\_v,\ gc);}
\DoxyCodeLine{00323\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ i\ =\ 0;\ i\ <\ r;\ ++i)\ \{\ tmp1(i,\ \_,\ \_)\ =\ \mbox{\hyperlink{namespacecppdlr_a623b3f78817239e2d1653be8972cc5f1}{arraymult}}(tmp1(i,\ \_,\ \_),\ gc(i,\ \_,\ \_))\ +\ \mbox{\hyperlink{namespacecppdlr_a623b3f78817239e2d1653be8972cc5f1}{arraymult}}(fc(i,\ \_,\ \_),\ tmp2(i,\ \_,\ \_));\ \}}
\DoxyCodeLine{00324\ }
\DoxyCodeLine{00325\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ beta\ *\ (h\ +\ \mbox{\hyperlink{namespacecppdlr_a623b3f78817239e2d1653be8972cc5f1}{arraymult}}(cf2it,\ tmp1));}
\DoxyCodeLine{00326\ }
\DoxyCodeLine{00327\ \ \ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00328\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{throw}\ std::runtime\_error(\textcolor{stringliteral}{"{}Input\ arrays\ must\ be\ rank\ 1\ (scalar-\/valued\ Green's\ function)\ or\ 3\ (matrix-\/valued\ Green's\ function)."{}});}
\DoxyCodeLine{00329\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00330\ \ \ \ \ \}}
\DoxyCodeLine{00331\ }
\DoxyCodeLine{00353\ \ \ \ \ \textcolor{keyword}{template}\ <nda::MemoryMatrix\ Tf,\ nda::MemoryArray\ Tg,\ nda::Scalar\ Sf\ =\ nda::get\_value\_t<Tf>,\ nda::Scalar\ Sg\ =\ nda::get\_value\_t<Tg>,}
\DoxyCodeLine{00354\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ nda::Scalar\ S\ =\ \textcolor{keyword}{typename}\ std::common\_type<Sf,\ Sg>::type>}
\DoxyCodeLine{00355\ \ \ \ \ \textcolor{keyword}{typename}\ Tg::regular\_type\ \mbox{\hyperlink{classcppdlr_1_1imtime__ops_a87b3e21ae66c97691a4580335795f77f}{convolve}}(Tf\ \textcolor{keyword}{const}\ \&fconv,\ Tg\ \textcolor{keyword}{const}\ \&g)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00356\ }
\DoxyCodeLine{00357\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (r\ !=\ g.shape(0))\ \textcolor{keywordflow}{throw}\ std::runtime\_error(\textcolor{stringliteral}{"{}First\ dim\ of\ input\ g\ must\ be\ equal\ to\ DLR\ rank\ r."{}});}
\DoxyCodeLine{00358\ }
\DoxyCodeLine{00359\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ \textcolor{keyword}{constexpr}\ (Tg::rank\ ==\ 1)\ \{\ \textcolor{comment}{//\ Scalar-\/valued\ Green's\ function}}
\DoxyCodeLine{00360\ }
\DoxyCodeLine{00361\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (fconv.shape(1)\ !=\ g.shape(0))\ \textcolor{keywordflow}{throw}\ std::runtime\_error(\textcolor{stringliteral}{"{}Input\ array\ dimensions\ incompatible."{}});}
\DoxyCodeLine{00362\ }
\DoxyCodeLine{00363\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \mbox{\hyperlink{namespacecppdlr_a623b3f78817239e2d1653be8972cc5f1}{arraymult}}(fconv,\ g);}
\DoxyCodeLine{00364\ }
\DoxyCodeLine{00365\ \ \ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \textcolor{keywordflow}{if}\ (Tg::rank\ ==\ 3)\ \{\ \textcolor{comment}{//\ Matrix-\/valued\ Green's\ function}}
\DoxyCodeLine{00366\ }
\DoxyCodeLine{00367\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (fconv.shape(1)\ !=\ g.shape(0)\ *\ g.shape(1))\ \textcolor{keywordflow}{throw}\ std::runtime\_error(\textcolor{stringliteral}{"{}Input\ array\ dimensions\ incompatible."{}});}
\DoxyCodeLine{00368\ }
\DoxyCodeLine{00369\ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{int}\ norb1\ =\ g.shape(1);}
\DoxyCodeLine{00370\ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{int}\ norb2\ =\ g.shape(2);}
\DoxyCodeLine{00371\ }
\DoxyCodeLine{00372\ \ \ \ \ \ \ \ \ \textcolor{keyword}{auto}\ h\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ =\ nda::array<S,\ 3>(r,\ norb1,\ norb2);}
\DoxyCodeLine{00373\ \ \ \ \ \ \ \ \ reshape(h,\ r\ *\ norb1,\ norb2)\ =\ \mbox{\hyperlink{namespacecppdlr_a623b3f78817239e2d1653be8972cc5f1}{arraymult}}(fconv,\ reshape(g,\ r\ *\ norb1,\ norb2));}
\DoxyCodeLine{00374\ }
\DoxyCodeLine{00375\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ h;}
\DoxyCodeLine{00376\ }
\DoxyCodeLine{00377\ \ \ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00378\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{throw}\ std::runtime\_error(\textcolor{stringliteral}{"{}Input\ arrays\ must\ be\ rank\ 1\ (scalar-\/valued\ Green's\ function)\ or\ 3\ (matrix-\/valued\ Green's\ function)."{}});}
\DoxyCodeLine{00379\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00380\ \ \ \ \ \}}
\DoxyCodeLine{00381\ }
\DoxyCodeLine{00426\ \ \ \ \ \textcolor{keyword}{template}\ <nda::MemoryArray\ T,\ nda::Scalar\ S\ =\ nda::get\_value\_t<T>>}
\DoxyCodeLine{00427\ \ \ \ \ nda::matrix<S>\ \mbox{\hyperlink{classcppdlr_1_1imtime__ops_a6c0a93f188f4522b2389e9a7fcbf9783}{convmat}}(\textcolor{keywordtype}{double}\ beta,\ \mbox{\hyperlink{namespacecppdlr_ad0a7e33d9a03f4986937032c25ee7435}{statistic\_t}}\ statistic,\ T\ \textcolor{keyword}{const}\ \&fc,\ \textcolor{keywordtype}{bool}\ time\_order\ =\ \textcolor{keyword}{false})\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00428\ }
\DoxyCodeLine{00429\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (r\ !=\ fc.shape(0))\ \textcolor{keywordflow}{throw}\ std::runtime\_error(\textcolor{stringliteral}{"{}First\ dim\ of\ input\ array\ must\ be\ equal\ to\ DLR\ rank\ r."{}});}
\DoxyCodeLine{00430\ }
\DoxyCodeLine{00431\ \ \ \ \ \ \ \textcolor{comment}{//\ TODO:\ implement\ bosonic\ case\ and\ remove}}
\DoxyCodeLine{00432\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (statistic\ ==\ 0)\ \textcolor{keywordflow}{throw}\ std::runtime\_error(\textcolor{stringliteral}{"{}imtime\_ops::convmat\ not\ yet\ implemented\ for\ bosonic\ Green's\ functions."{}});}
\DoxyCodeLine{00433\ }
\DoxyCodeLine{00434\ \ \ \ \ \ \ \textcolor{comment}{//\ Initialize\ convolution,\ if\ it\ hasn't\ been\ done\ already}}
\DoxyCodeLine{00435\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (!time\_order\ \&\ hilb.empty())\ \{\ \mbox{\hyperlink{classcppdlr_1_1imtime__ops_a6257e0b3f43733c5ac06c8af11a47bb3}{convolve\_init}}();\ \}}
\DoxyCodeLine{00436\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (time\_order\ \&\ thilb.empty())\ \{\ \mbox{\hyperlink{classcppdlr_1_1imtime__ops_ae6116f42e1f17050404974d0d6d3d226}{tconvolve\_init}}();\ \}}
\DoxyCodeLine{00437\ }
\DoxyCodeLine{00438\ \ \ \ \ \ \ \textcolor{comment}{//\ Get\ view\ of\ helper\ matrices\ based\ on\ time\_order\ flag}}
\DoxyCodeLine{00439\ \ \ \ \ \ \ \textcolor{keyword}{auto}\ hilb\_v\ \ \ =\ (time\_order\ ?\ nda::matrix\_const\_view<double>(thilb)\ :\ nda::matrix\_const\_view<double>(hilb));}
\DoxyCodeLine{00440\ \ \ \ \ \ \ \textcolor{keyword}{auto}\ tcf2it\_v\ =\ (time\_order\ ?\ nda::matrix\_const\_view<double>(ttcf2it)\ :\ nda::matrix\_const\_view<double>(tcf2it));}
\DoxyCodeLine{00441\ }
\DoxyCodeLine{00442\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ \textcolor{keyword}{constexpr}\ (T::rank\ ==\ 1)\ \{\ \textcolor{comment}{//\ Scalar-\/valued\ Green's\ function}}
\DoxyCodeLine{00443\ }
\DoxyCodeLine{00444\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ First\ construct\ convolution\ matrix\ from\ DLR\ coefficients\ to\ DLR\ grid}}
\DoxyCodeLine{00445\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ values}}
\DoxyCodeLine{00446\ \ \ \ \ \ \ \ \ \textcolor{keyword}{auto}\ fconv\ =\ nda::matrix<S>(r,\ r);\ \textcolor{comment}{//\ Matrix\ of\ convolution\ by\ f}}
\DoxyCodeLine{00447\ }
\DoxyCodeLine{00448\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Diagonal\ contribution\ (given\ by\ diag(tau\_k)\ *\ K(tau\_k,\ om\_l)\ *\ diag(fc\_l))}}
\DoxyCodeLine{00449\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ k\ =\ 0;\ k\ <\ r;\ ++k)\ \{}
\DoxyCodeLine{00450\ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ l\ =\ 0;\ l\ <\ r;\ ++l)\ \{\ fconv(k,\ l)\ =\ tcf2it\_v(k,\ l)\ *\ fc(l);\ \}}
\DoxyCodeLine{00451\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00452\ }
\DoxyCodeLine{00453\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Off-\/diagonal\ contribution\ (given\ by\ K\ *\ (diag(hilb*fc)\ +}}
\DoxyCodeLine{00454\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ (diag(fc)*hilb)),\ where\ K\ is\ the\ matrix\ K(dlr\_it(k),\ dlr\_rf(l))}}
\DoxyCodeLine{00455\ \ \ \ \ \ \ \ \ \textcolor{keyword}{auto}\ tmp1\ =\ \mbox{\hyperlink{namespacecppdlr_a623b3f78817239e2d1653be8972cc5f1}{arraymult}}(hilb\_v,\ fc);\ \textcolor{comment}{//\ hilb\ *\ fc}}
\DoxyCodeLine{00456\ \ \ \ \ \ \ \ \ \textcolor{keyword}{auto}\ tmp2\ =\ nda::matrix<S>(r,\ r);}
\DoxyCodeLine{00457\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ k\ =\ 0;\ k\ <\ r;\ ++k)\ \{}
\DoxyCodeLine{00458\ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ l\ =\ 0;\ l\ <\ r;\ ++l)\ \{}
\DoxyCodeLine{00459\ \ \ \ \ \ \ \ \ \ \ \ \ tmp2(k,\ l)\ =\ fc(k)\ *\ hilb\_v(k,\ l);\ \textcolor{comment}{//\ diag(fc)\ *\ hilb}}
\DoxyCodeLine{00460\ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00461\ \ \ \ \ \ \ \ \ \ \ tmp2(k,\ k)\ +=\ tmp1(k);\ \textcolor{comment}{//\ diag(fc)*hilb\ +\ diag(hilb*fc)}}
\DoxyCodeLine{00462\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00463\ \ \ \ \ \ \ \ \ fconv\ +=\ \mbox{\hyperlink{namespacecppdlr_a623b3f78817239e2d1653be8972cc5f1}{arraymult}}(cf2it,\ tmp2);}
\DoxyCodeLine{00464\ }
\DoxyCodeLine{00465\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Then\ precompose\ with\ DLR\ grid\ values\ to\ DLR\ coefficients\ matrix}}
\DoxyCodeLine{00466\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ \textcolor{keyword}{constexpr}\ (nda::have\_same\_value\_type\_v<T,\ \textcolor{keyword}{decltype}(it2cf.lu)>)\ \{}
\DoxyCodeLine{00467\ \ \ \ \ \ \ \ \ \ \ nda::lapack::getrs(transpose(it2cf.lu),\ fconv,\ it2cf.piv);\ \textcolor{comment}{//\ Note:\ lapack\ effectively\ tranposes\ fconv\ by\ fortran\ reordering\ here}}
\DoxyCodeLine{00468\ \ \ \ \ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00469\ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ getrs\ requires\ matrix\ and\ rhs\ to\ have\ same\ value\ type}}
\DoxyCodeLine{00470\ \ \ \ \ \ \ \ \ \ \ nda::lapack::getrs(transpose(nda::matrix<S>(it2cf.lu)),\ fconv,\ it2cf.piv);}
\DoxyCodeLine{00471\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00472\ }
\DoxyCodeLine{00473\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ beta\ *\ fconv;}
\DoxyCodeLine{00474\ }
\DoxyCodeLine{00475\ \ \ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \textcolor{keywordflow}{if}\ (T::rank\ ==\ 3)\ \{\ \textcolor{comment}{//\ Matrix-\/valued\ Green's\ function}}
\DoxyCodeLine{00476\ }
\DoxyCodeLine{00477\ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{int}\ norb1\ =\ fc.shape(1);}
\DoxyCodeLine{00478\ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{int}\ norb2\ =\ fc.shape(2);}
\DoxyCodeLine{00479\ }
\DoxyCodeLine{00480\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ First\ construct\ convolution\ matrix\ from\ DLR\ coefficients\ to\ DLR\ grid}}
\DoxyCodeLine{00481\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ values}}
\DoxyCodeLine{00482\ \ \ \ \ \ \ \ \ \textcolor{keyword}{auto}\ fconv\ \ \ \ =\ nda::matrix<S>(r\ *\ norb1,\ r\ *\ norb2);\ \ \ \ \textcolor{comment}{//\ Matrix\ of\ convolution\ by\ f}}
\DoxyCodeLine{00483\ \ \ \ \ \ \ \ \ \textcolor{keyword}{auto}\ fconv\_rs\ =\ nda::reshape(fconv,\ r,\ norb1,\ r,\ norb2);\ \textcolor{comment}{//\ Array\ view\ to\ index\ into\ fconv\ for\ conevenience}}
\DoxyCodeLine{00484\ }
\DoxyCodeLine{00485\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Diagonal\ contribution\ (given\ by\ diag(tau\_k)\ *\ K(tau\_k,\ om\_l)\ *\ diag(fc\_l))}}
\DoxyCodeLine{00486\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ k\ =\ 0;\ k\ <\ r;\ ++k)\ \{}
\DoxyCodeLine{00487\ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ l\ =\ 0;\ l\ <\ r;\ ++l)\ \{\ fconv\_rs(k,\ \_,\ l,\ \_)\ =\ tcf2it\_v(k,\ l)\ *\ fc(l,\ \_,\ \_);\ \}}
\DoxyCodeLine{00488\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00489\ }
\DoxyCodeLine{00490\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Off-\/diagonal\ contribution\ (given\ by\ K\ *\ (diag(hilb*fc)\ +}}
\DoxyCodeLine{00491\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ (diag(fc)*hilb)),\ where\ K\ is\ the\ matrix\ K(dlr\_it(k),\ dlr\_rf(l))}}
\DoxyCodeLine{00492\ \ \ \ \ \ \ \ \ \textcolor{keyword}{auto}\ tmp1\ =\ \mbox{\hyperlink{namespacecppdlr_a623b3f78817239e2d1653be8972cc5f1}{arraymult}}(hilb\_v,\ fc);\ \textcolor{comment}{//\ hilb\ *\ fc}}
\DoxyCodeLine{00493\ \ \ \ \ \ \ \ \ \textcolor{keyword}{auto}\ tmp2\ =\ nda::array<S,\ 4>(r,\ norb1,\ r,\ norb2);}
\DoxyCodeLine{00494\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ k\ =\ 0;\ k\ <\ r;\ ++k)\ \{}
\DoxyCodeLine{00495\ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ l\ =\ 0;\ l\ <\ r;\ ++l)\ \{}
\DoxyCodeLine{00496\ \ \ \ \ \ \ \ \ \ \ \ \ tmp2(k,\ \_,\ l,\ \_)\ =\ fc(k,\ \_,\ \_)\ *\ hilb\_v(k,\ l);\ \textcolor{comment}{//\ diag(fc)\ *\ hilb}}
\DoxyCodeLine{00497\ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00498\ \ \ \ \ \ \ \ \ \ \ tmp2(k,\ \_,\ k,\ \_)\ +=\ tmp1(k,\ \_,\ \_);\ \textcolor{comment}{//\ diag(fc)*hilb\ +\ diag(hilb*fc)}}
\DoxyCodeLine{00499\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00500\ \ \ \ \ \ \ \ \ fconv\_rs\ +=\ \mbox{\hyperlink{namespacecppdlr_a623b3f78817239e2d1653be8972cc5f1}{arraymult}}(cf2it,\ tmp2);}
\DoxyCodeLine{00501\ }
\DoxyCodeLine{00502\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Then\ precompose\ with\ DLR\ grid\ values\ to\ DLR\ coefficients\ matrix}}
\DoxyCodeLine{00503\ }
\DoxyCodeLine{00504\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Transpose\ last\ two\ indices\ to\ put\ make\ column\ DLR\ index\ the\ last}}
\DoxyCodeLine{00505\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ index}}
\DoxyCodeLine{00506\ \ \ \ \ \ \ \ \ \textcolor{keyword}{auto}\ fconvtmp\ \ \ \ =\ nda::matrix<S>(r\ *\ norb1\ *\ norb2,\ r);}
\DoxyCodeLine{00507\ \ \ \ \ \ \ \ \ \textcolor{keyword}{auto}\ fconvtmp\_rs\ =\ nda::reshape(fconvtmp,\ r,\ norb1,\ norb2,\ r);}
\DoxyCodeLine{00508\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ i\ =\ 0;\ i\ <\ norb2;\ ++i)\ \{}
\DoxyCodeLine{00509\ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ k\ =\ 0;\ k\ <\ r;\ ++k)\ \{\ fconvtmp\_rs(\_,\ \_,\ i,\ k)\ =\ fconv\_rs(\_,\ \_,\ k,\ i);\ \}}
\DoxyCodeLine{00510\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00511\ }
\DoxyCodeLine{00512\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Do\ the\ solve}}
\DoxyCodeLine{00513\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ \textcolor{keyword}{constexpr}\ (nda::have\_same\_value\_type\_v<T,\ \textcolor{keyword}{decltype}(it2cf.lu)>)\ \{}
\DoxyCodeLine{00514\ \ \ \ \ \ \ \ \ \ \ nda::lapack::getrs(transpose(it2cf.lu),\ fconvtmp,\ it2cf.piv);\ \textcolor{comment}{//\ Note:\ lapack\ effectively\ tranposes\ fconv\ by\ fortran\ reordering\ here}}
\DoxyCodeLine{00515\ \ \ \ \ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00516\ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ getrs\ requires\ matrix\ and\ rhs\ to\ have\ same\ value\ type}}
\DoxyCodeLine{00517\ \ \ \ \ \ \ \ \ \ \ nda::lapack::getrs(transpose(nda::matrix<S>(it2cf.lu)),\ fconvtmp,\ it2cf.piv);}
\DoxyCodeLine{00518\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00519\ }
\DoxyCodeLine{00520\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Transpose\ back}}
\DoxyCodeLine{00521\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ i\ =\ 0;\ i\ <\ norb2;\ ++i)\ \{}
\DoxyCodeLine{00522\ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ k\ =\ 0;\ k\ <\ r;\ ++k)\ \{\ fconv\_rs(\_,\ \_,\ k,\ i)\ =\ fconvtmp\_rs(\_,\ \_,\ i,\ k);\ \}}
\DoxyCodeLine{00523\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00524\ }
\DoxyCodeLine{00525\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ beta\ *\ fconv;}
\DoxyCodeLine{00526\ }
\DoxyCodeLine{00527\ \ \ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00528\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{throw}\ std::runtime\_error(\textcolor{stringliteral}{"{}Input\ arrays\ must\ be\ rank\ 1\ (scalar-\/valued\ Green's\ function)\ or\ 3\ (matrix-\/valued\ Green's\ function)."{}});}
\DoxyCodeLine{00529\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00530\ \ \ \ \ \}}
\DoxyCodeLine{00531\ }
\DoxyCodeLine{00537\ \ \ \ \ nda::vector\_const\_view<double>\ \mbox{\hyperlink{classcppdlr_1_1imtime__ops_ae20e69067cc04e37fe8448e8d1088776}{get\_itnodes}}()\textcolor{keyword}{\ const\ }\{\ \textcolor{keywordflow}{return}\ dlr\_it;\ \};}
\DoxyCodeLine{00538\ \ \ \ \ \textcolor{keywordtype}{double}\ \mbox{\hyperlink{classcppdlr_1_1imtime__ops_aec1395480d77a2f400b62171e553b0f4}{get\_itnodes}}(\textcolor{keywordtype}{int}\ i)\textcolor{keyword}{\ const\ }\{\ \textcolor{keywordflow}{return}\ dlr\_it(i);\ \};}
\DoxyCodeLine{00539\ }
\DoxyCodeLine{00546\ \ \ \ \ nda::vector\_const\_view<double>\ \mbox{\hyperlink{classcppdlr_1_1imtime__ops_ae5f9dc847c716f5d8b0ea92d56777263}{get\_rfnodes}}()\textcolor{keyword}{\ const\ }\{\ \textcolor{keywordflow}{return}\ dlr\_rf;\ \};}
\DoxyCodeLine{00547\ \ \ \ \ \textcolor{keywordtype}{double}\ \mbox{\hyperlink{classcppdlr_1_1imtime__ops_ac58745b133d7a289d897c920ee89f671}{get\_rfnodes}}(\textcolor{keywordtype}{int}\ i)\textcolor{keyword}{\ const\ }\{\ \textcolor{keywordflow}{return}\ dlr\_rf(i);\ \};}
\DoxyCodeLine{00548\ }
\DoxyCodeLine{00554\ \ \ \ \ nda::matrix\_const\_view<double>\ \mbox{\hyperlink{classcppdlr_1_1imtime__ops_a6cb8521ca54bb5efa1464693679185ba}{get\_cf2it}}()\textcolor{keyword}{\ const\ }\{\ \textcolor{keywordflow}{return}\ cf2it;\ \};}
\DoxyCodeLine{00555\ }
\DoxyCodeLine{00561\ \ \ \ \ nda::matrix\_const\_view<double>\ \mbox{\hyperlink{classcppdlr_1_1imtime__ops_a44acd4cd20cbe95632534891644f1806}{get\_it2cf\_lu}}()\textcolor{keyword}{\ const\ }\{\ \textcolor{keywordflow}{return}\ it2cf.lu;\ \};}
\DoxyCodeLine{00562\ }
\DoxyCodeLine{00568\ \ \ \ \ nda::vector\_const\_view<int>\ \mbox{\hyperlink{classcppdlr_1_1imtime__ops_a44d6669d27cdd0f51d74fa2d7b2885de}{get\_it2cf\_piv}}()\textcolor{keyword}{\ const\ }\{\ \textcolor{keywordflow}{return}\ it2cf.piv;\ \};}
\DoxyCodeLine{00569\ }
\DoxyCodeLine{00575\ \ \ \ \ \textcolor{keywordtype}{int}\ \mbox{\hyperlink{classcppdlr_1_1imtime__ops_a88f437cb31c98929ab8a1e6dadb174aa}{rank}}()\textcolor{keyword}{\ const\ }\{\ \textcolor{keywordflow}{return}\ r;\ \}}
\DoxyCodeLine{00576\ \ \ \ \ \textcolor{keywordtype}{double}\ \mbox{\hyperlink{classcppdlr_1_1imtime__ops_a401521dedc309ca12c1ec345da983c80}{lambda}}()\textcolor{keyword}{\ const\ }\{\ \textcolor{keywordflow}{return}\ lambda\_;\ \}}
\DoxyCodeLine{00577\ }
\DoxyCodeLine{00586\ \ \ \ \ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classcppdlr_1_1imtime__ops_a6257e0b3f43733c5ac06c8af11a47bb3}{convolve\_init}}()\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00587\ }
\DoxyCodeLine{00588\ \ \ \ \ \ \ hilb\ \ \ =\ nda::matrix<double>(r,\ r);}
\DoxyCodeLine{00589\ \ \ \ \ \ \ tcf2it\ =\ nda::matrix<double>(r,\ r);}
\DoxyCodeLine{00590\ }
\DoxyCodeLine{00591\ \ \ \ \ \ \ \textcolor{comment}{//\ "{}Discrete\ Hilbert\ transform"{}\ matrix\ -\/(1-\/delta\_jk)/(dlr\_rf(j)\ -\/}}
\DoxyCodeLine{00592\ \ \ \ \ \ \ \textcolor{comment}{//\ dlr\_rf(k)),\ scaled\ by\ beta}}
\DoxyCodeLine{00593\ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ j\ =\ 0;\ j\ <\ r;\ ++j)\ \{}
\DoxyCodeLine{00594\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ k\ =\ 0;\ k\ <\ r;\ ++k)\ \{}
\DoxyCodeLine{00595\ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (j\ ==\ k)\ \{}
\DoxyCodeLine{00596\ \ \ \ \ \ \ \ \ \ \ \ \ hilb(j,\ k)\ =\ 0;}
\DoxyCodeLine{00597\ \ \ \ \ \ \ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00598\ \ \ \ \ \ \ \ \ \ \ \ \ hilb(j,\ k)\ =\ 1.0\ /\ (dlr\_rf(j)\ -\/\ dlr\_rf(k));}
\DoxyCodeLine{00599\ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00600\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00601\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00602\ }
\DoxyCodeLine{00603\ \ \ \ \ \ \ \textcolor{comment}{//\ Matrix\ which\ applies\ DLR\ coefficients\ to\ imaginary\ time\ grid\ values}}
\DoxyCodeLine{00604\ \ \ \ \ \ \ \textcolor{comment}{//\ transformation\ matrix,\ and\ then\ multiplies\ the\ result\ by\ tau,\ the}}
\DoxyCodeLine{00605\ \ \ \ \ \ \ \textcolor{comment}{//\ imaginary\ time\ variable}}
\DoxyCodeLine{00606\ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ j\ =\ 0;\ j\ <\ r;\ ++j)\ \{}
\DoxyCodeLine{00607\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ k\ =\ 0;\ k\ <\ r;\ ++k)\ \{}
\DoxyCodeLine{00608\ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (dlr\_it(j)\ >\ 0)\ \{}
\DoxyCodeLine{00609\ \ \ \ \ \ \ \ \ \ \ \ \ tcf2it(j,\ k)\ =\ -\/(dlr\_it(j)\ +\ \mbox{\hyperlink{namespacecppdlr_afc9726e02898098dfff8448f02f5b3c6}{k\_it}}(1.0,\ dlr\_rf(k)))\ *\ cf2it(j,\ k);}
\DoxyCodeLine{00610\ \ \ \ \ \ \ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00611\ \ \ \ \ \ \ \ \ \ \ \ \ tcf2it(j,\ k)\ =\ -\/(dlr\_it(j)\ -\/\ \mbox{\hyperlink{namespacecppdlr_afc9726e02898098dfff8448f02f5b3c6}{k\_it}}(0.0,\ dlr\_rf(k)))\ *\ cf2it(j,\ k);}
\DoxyCodeLine{00612\ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00613\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00614\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00615\ \ \ \ \ \}}
\DoxyCodeLine{00616\ }
\DoxyCodeLine{00626\ \ \ \ \ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classcppdlr_1_1imtime__ops_ae6116f42e1f17050404974d0d6d3d226}{tconvolve\_init}}()\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00627\ }
\DoxyCodeLine{00628\ \ \ \ \ \ \ thilb\ \ \ =\ nda::matrix<double>(r,\ r);}
\DoxyCodeLine{00629\ \ \ \ \ \ \ ttcf2it\ =\ nda::matrix<double>(r,\ r);}
\DoxyCodeLine{00630\ }
\DoxyCodeLine{00631\ \ \ \ \ \ \ \textcolor{comment}{//\ "{}Discrete\ Hilbert\ transform"{}\ matrix}}
\DoxyCodeLine{00632\ \ \ \ \ \ \ \textcolor{comment}{//\ -\/(1-\/delta\_jk)*K(0,dlr\_rf(k))/(dlr\_rf(j)\ -\/\ dlr\_rf(k))\ for\ time-\/ordered}}
\DoxyCodeLine{00633\ \ \ \ \ \ \ \textcolor{comment}{//\ convolution,\ scaled\ by\ beta}}
\DoxyCodeLine{00634\ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ j\ =\ 0;\ j\ <\ r;\ ++j)\ \{}
\DoxyCodeLine{00635\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ k\ =\ 0;\ k\ <\ r;\ ++k)\ \{}
\DoxyCodeLine{00636\ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (j\ ==\ k)\ \{}
\DoxyCodeLine{00637\ \ \ \ \ \ \ \ \ \ \ \ \ thilb(j,\ k)\ =\ 0;}
\DoxyCodeLine{00638\ \ \ \ \ \ \ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00639\ \ \ \ \ \ \ \ \ \ \ \ \ thilb(j,\ k)\ =\ \mbox{\hyperlink{namespacecppdlr_afc9726e02898098dfff8448f02f5b3c6}{k\_it}}(0.0,\ dlr\_rf(k))\ /\ (dlr\_rf(k)\ -\/\ dlr\_rf(j));}
\DoxyCodeLine{00640\ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00641\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00642\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00643\ }
\DoxyCodeLine{00644\ \ \ \ \ \ \ \textcolor{comment}{//\ Matrix\ which\ applies\ K(0,dlr\_rf(j))\ multiplication,\ then\ DLR}}
\DoxyCodeLine{00645\ \ \ \ \ \ \ \textcolor{comment}{//\ coefficients\ to\ imaginary\ time\ grid\ values\ transformation\ matrix,\ and}}
\DoxyCodeLine{00646\ \ \ \ \ \ \ \textcolor{comment}{//\ then\ multiplies\ the\ result\ by\ tau,\ the\ imaginary\ time\ variable}}
\DoxyCodeLine{00647\ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ j\ =\ 0;\ j\ <\ r;\ ++j)\ \{}
\DoxyCodeLine{00648\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ k\ =\ 0;\ k\ <\ r;\ ++k)\ \{}
\DoxyCodeLine{00649\ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (dlr\_it(j)\ >\ 0)\ \{}
\DoxyCodeLine{00650\ \ \ \ \ \ \ \ \ \ \ \ \ ttcf2it(j,\ k)\ =\ dlr\_it(j)\ *\ cf2it(j,\ k)\ *\ \mbox{\hyperlink{namespacecppdlr_afc9726e02898098dfff8448f02f5b3c6}{k\_it}}(0.0,\ dlr\_rf(k));}
\DoxyCodeLine{00651\ \ \ \ \ \ \ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00652\ \ \ \ \ \ \ \ \ \ \ \ \ ttcf2it(j,\ k)\ =\ (1\ +\ dlr\_it(j))\ *\ cf2it(j,\ k)\ *\ \mbox{\hyperlink{namespacecppdlr_afc9726e02898098dfff8448f02f5b3c6}{k\_it}}(0.0,\ dlr\_rf(k));}
\DoxyCodeLine{00653\ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00654\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00655\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00656\ \ \ \ \ \}}
\DoxyCodeLine{00657\ }
\DoxyCodeLine{00667\ \ \ \ \ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classcppdlr_1_1imtime__ops_a3a47942235e7330cc6d392dc881d256f}{reflect\_init}}()\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00668\ }
\DoxyCodeLine{00669\ \ \ \ \ \ \ refl\ =\ nda::matrix<double>(r,\ r);}
\DoxyCodeLine{00670\ }
\DoxyCodeLine{00671\ \ \ \ \ \ \ \textcolor{comment}{//\ Matrix\ of\ reflection\ acting\ on\ DLR\ coefficients\ and\ returning\ values\ at}}
\DoxyCodeLine{00672\ \ \ \ \ \ \ \textcolor{comment}{//\ DLR\ nodes}}
\DoxyCodeLine{00673\ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ i\ =\ 0;\ i\ <\ r;\ ++i)\ \{}
\DoxyCodeLine{00674\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ j\ =\ 0;\ j\ <\ r;\ ++j)\ \{\ refl(i,\ j)\ =\ \mbox{\hyperlink{namespacecppdlr_afc9726e02898098dfff8448f02f5b3c6}{k\_it}}(-\/dlr\_it(i),\ dlr\_rf(j));\ \}}
\DoxyCodeLine{00675\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00676\ }
\DoxyCodeLine{00677\ \ \ \ \ \ \ \textcolor{comment}{//\ Precompose\ with\ DLR\ values\ to\ coefficients\ matrix}}
\DoxyCodeLine{00678\ \ \ \ \ \ \ nda::lapack::getrs(transpose(it2cf.lu),\ refl,\ it2cf.piv);\ \textcolor{comment}{//\ Lapack\ effectively\ transposes\ refl\ by\ fortran\ reordering\ here}}
\DoxyCodeLine{00679\ \ \ \ \ \}}
\DoxyCodeLine{00680\ }
\DoxyCodeLine{00681\ \ \ \ \ \textcolor{keyword}{private}:}
\DoxyCodeLine{00682\ \ \ \ \ \textcolor{keywordtype}{double}\ lambda\_;}
\DoxyCodeLine{00683\ \ \ \ \ \textcolor{keywordtype}{int}\ r;\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ }
\DoxyCodeLine{00684\ \ \ \ \ nda::vector<double>\ dlr\_rf;\ }
\DoxyCodeLine{00685\ \ \ \ \ nda::vector<double>\ dlr\_it;\ }
\DoxyCodeLine{00686\ \ \ \ \ nda::matrix<double>\ cf2it;\ \ }
\DoxyCodeLine{00687\ }
\DoxyCodeLine{00691\ \ \ \ \ \textcolor{keyword}{struct\ }\{}
\DoxyCodeLine{00692\ \ \ \ \ \ \ nda::matrix<double>\ \mbox{\hyperlink{classcppdlr_1_1imtime__ops_a83e9085aca345c3bf889ae006f0fdb3d}{lu}};\ }
\DoxyCodeLine{00693\ \ \ \ \ \ \ nda::vector<int>\ \mbox{\hyperlink{classcppdlr_1_1imtime__ops_a7cd0e6b5498400d3afade53a6ebab389}{piv}};\ \ \ }
\DoxyCodeLine{00694\ \ \ \ \ \}\ it2cf;}
\DoxyCodeLine{00695\ }
\DoxyCodeLine{00696\ \ \ \ \ \textcolor{comment}{//\ Arrays\ used\ for\ dlr\_imtime::convolve}}
\DoxyCodeLine{00697\ \ \ \ \ \textcolor{keyword}{mutable}\ nda::matrix<double>\ hilb;\ \ \ }
\DoxyCodeLine{00698\ \ \ \ \ \textcolor{keyword}{mutable}\ nda::matrix<double>\ tcf2it;\ }
\DoxyCodeLine{00699\ }
\DoxyCodeLine{00700\ \ \ \ \ \textcolor{comment}{//\ Arrays\ used\ for\ dlr\_imtime::tconvolve}}
\DoxyCodeLine{00701\ \ \ \ \ \textcolor{keyword}{mutable}\ nda::matrix<double>\ thilb;\ \ \ }
\DoxyCodeLine{00702\ \ \ \ \ \textcolor{keyword}{mutable}\ nda::matrix<double>\ ttcf2it;\ }
\DoxyCodeLine{00703\ }
\DoxyCodeLine{00704\ \ \ \ \ \textcolor{comment}{//\ Arrays\ used\ for\ dlr\_imtime::reflect}}
\DoxyCodeLine{00705\ \ \ \ \ \textcolor{keyword}{mutable}\ nda::matrix<double>\ refl;\ }
\DoxyCodeLine{00706\ }
\DoxyCodeLine{00707\ \ \ \ \ \textcolor{comment}{//\ -\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/\ hdf5\ -\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/}}
\DoxyCodeLine{00708\ }
\DoxyCodeLine{00709\ \ \ \ \ \textcolor{keyword}{public}:}
\DoxyCodeLine{00710\ \ \ \ \ \textcolor{keyword}{static}\ std::string\ \mbox{\hyperlink{classcppdlr_1_1imtime__ops_a649d9f6c3d257661818c3f473f49f57a}{hdf5\_format}}()\ \{\ \textcolor{keywordflow}{return}\ \textcolor{stringliteral}{"{}cppdlr::imtime\_ops"{}};\ \}}
\DoxyCodeLine{00711\ }
\DoxyCodeLine{00712\ \ \ \ \ \textcolor{keyword}{friend}\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classcppdlr_1_1imtime__ops_a0eec6aaaea35d7bba7e92951a0de76db}{h5\_write}}(h5::group\ fg,\ std::string\ \textcolor{keyword}{const}\ \&subgroup\_name,\ \mbox{\hyperlink{classcppdlr_1_1imtime__ops}{imtime\_ops}}\ \textcolor{keyword}{const}\ \&m)\ \{}
\DoxyCodeLine{00713\ }
\DoxyCodeLine{00714\ \ \ \ \ \ \ h5::group\ gr\ =\ fg.create\_group(subgroup\_name);}
\DoxyCodeLine{00715\ \ \ \ \ \ \ write\_hdf5\_format(gr,\ m);}
\DoxyCodeLine{00716\ }
\DoxyCodeLine{00717\ \ \ \ \ \ \ h5::write(gr,\ \textcolor{stringliteral}{"{}lambda"{}},\ m.\mbox{\hyperlink{classcppdlr_1_1imtime__ops_a401521dedc309ca12c1ec345da983c80}{lambda}}());}
\DoxyCodeLine{00718\ \ \ \ \ \ \ h5::write(gr,\ \textcolor{stringliteral}{"{}rf"{}},\ m.\mbox{\hyperlink{classcppdlr_1_1imtime__ops_ae5f9dc847c716f5d8b0ea92d56777263}{get\_rfnodes}}());}
\DoxyCodeLine{00719\ \ \ \ \ \ \ h5::write(gr,\ \textcolor{stringliteral}{"{}it"{}},\ m.\mbox{\hyperlink{classcppdlr_1_1imtime__ops_ae20e69067cc04e37fe8448e8d1088776}{get\_itnodes}}());}
\DoxyCodeLine{00720\ \ \ \ \ \ \ h5::write(gr,\ \textcolor{stringliteral}{"{}cf2it"{}},\ m.\mbox{\hyperlink{classcppdlr_1_1imtime__ops_a6cb8521ca54bb5efa1464693679185ba}{get\_cf2it}}());}
\DoxyCodeLine{00721\ \ \ \ \ \ \ h5::write(gr,\ \textcolor{stringliteral}{"{}it2cf\_lu"{}},\ m.\mbox{\hyperlink{classcppdlr_1_1imtime__ops_a44acd4cd20cbe95632534891644f1806}{get\_it2cf\_lu}}());}
\DoxyCodeLine{00722\ \ \ \ \ \ \ h5::write(gr,\ \textcolor{stringliteral}{"{}it2cf\_piv"{}},\ m.\mbox{\hyperlink{classcppdlr_1_1imtime__ops_a44d6669d27cdd0f51d74fa2d7b2885de}{get\_it2cf\_piv}}());}
\DoxyCodeLine{00723\ \ \ \ \ \}}
\DoxyCodeLine{00724\ }
\DoxyCodeLine{00725\ \ \ \ \ \textcolor{keyword}{friend}\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classcppdlr_1_1imtime__ops_a02e5f8519e54734a74b94226d10e082d}{h5\_read}}(h5::group\ fg,\ std::string\ \textcolor{keyword}{const}\ \&subgroup\_name,\ \mbox{\hyperlink{classcppdlr_1_1imtime__ops}{imtime\_ops}}\ \&m)\ \{}
\DoxyCodeLine{00726\ }
\DoxyCodeLine{00727\ \ \ \ \ \ \ h5::group\ gr\ =\ fg.open\_group(subgroup\_name);}
\DoxyCodeLine{00728\ \ \ \ \ \ \ assert\_hdf5\_format(gr,\ m);}
\DoxyCodeLine{00729\ }
\DoxyCodeLine{00730\ \ \ \ \ \ \ \textcolor{keyword}{auto}\ \mbox{\hyperlink{classcppdlr_1_1imtime__ops_a401521dedc309ca12c1ec345da983c80}{lambda}}\ \ \ \ =\ h5::read<double>(gr,\ \textcolor{stringliteral}{"{}lambda"{}});}
\DoxyCodeLine{00731\ \ \ \ \ \ \ \textcolor{keyword}{auto}\ rf\ \ \ \ \ \ \ \ =\ h5::read<nda::vector<double>>(gr,\ \textcolor{stringliteral}{"{}rf"{}});}
\DoxyCodeLine{00732\ \ \ \ \ \ \ \textcolor{keyword}{auto}\ it\ \ \ \ \ \ \ \ =\ h5::read<nda::vector<double>>(gr,\ \textcolor{stringliteral}{"{}it"{}});}
\DoxyCodeLine{00733\ \ \ \ \ \ \ \textcolor{keyword}{auto}\ cf2it\ \ \ \ \ =\ h5::read<nda::matrix<double>>(gr,\ \textcolor{stringliteral}{"{}cf2it"{}});}
\DoxyCodeLine{00734\ \ \ \ \ \ \ \textcolor{keyword}{auto}\ it2cf\_lu\ \ =\ h5::read<nda::matrix<double>>(gr,\ \textcolor{stringliteral}{"{}it2cf\_lu"{}});}
\DoxyCodeLine{00735\ \ \ \ \ \ \ \textcolor{keyword}{auto}\ it2cf\_piv\ =\ h5::read<nda::vector<int>>(gr,\ \textcolor{stringliteral}{"{}it2cf\_piv"{}});}
\DoxyCodeLine{00736\ }
\DoxyCodeLine{00737\ \ \ \ \ \ \ m\ =\ \mbox{\hyperlink{classcppdlr_1_1imtime__ops_a8da78cf54d39d48d2be19ad1f146b03c}{imtime\_ops}}(\mbox{\hyperlink{classcppdlr_1_1imtime__ops_a401521dedc309ca12c1ec345da983c80}{lambda}},\ rf,\ it,\ cf2it,\ it2cf\_lu,\ it2cf\_piv);}
\DoxyCodeLine{00738\ \ \ \ \ \}}
\DoxyCodeLine{00739\ \ \ \};}
\DoxyCodeLine{00740\ }
\DoxyCodeLine{00741\ \}\ \textcolor{comment}{//\ namespace\ cppdlr}}

\end{DoxyCode}
